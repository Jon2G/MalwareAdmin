using Kit;
using System.Diagnostics;
using System.Diagnostics.CodeAnalysis;
using System.Text;

namespace MalwareAdmin.Utils
{
    public class ProcessContoller
    {
        public const string LinuxTerminal = "/bin/bash";
        [NotNull]
        private readonly Process Process;
        private StreamReader ErrorReader => Process.StandardError;
        private StreamReader Reader => Process.StandardOutput;
        private StreamWriter Writer => Process.StandardInput;
        public string OutputData { get; private set; }
        public string ErrorData { get; private set; }
        public ProcessContoller([NotNull] Process process)
        {
            this.Process = process;
            this.Writer.AutoFlush = false;
            this.Process.OutputDataReceived += OutputDataReceived;
            this.Process.ErrorDataReceived += OutputDataReceived;
        }
        private void OutputDataReceived(object sender, DataReceivedEventArgs e)
        {
            if (string.IsNullOrEmpty(e.Data)) return;
            string data = e.Data.Replace("\0", string.Empty)?.Trim();
            if (string.IsNullOrEmpty(data)) return;
            if (data.StartsWith("Microsoft Windows") || data.Contains("Microsoft Corporation") ||
                data.Contains("PowerShell") || data == "viper >")
            {
                return;
            }
            Console.Write(data);
            //cmdLog.Log(data, isError);
            //sb.AppendLine(data);
        }

        internal static ProcessContoller Start(string file)
        {
            try
            {
                Console.WriteLine("Run process:{0}", arg: file);
                var p = new Process
                {
                    StartInfo = new ProcessStartInfo
                    {
                        FileName = file,
                        CreateNoWindow = true,
                        WindowStyle = ProcessWindowStyle.Hidden,
                        UseShellExecute = false,
                        RedirectStandardOutput = true,
                        RedirectStandardInput = true,
                        RedirectStandardError = true,
                        ErrorDialog = true,

                        StandardErrorEncoding = Encoding.UTF8,
                        //StandardInputEncoding = Encoding.UTF8,
                        StandardOutputEncoding = Encoding.UTF8,
                    }
                };
                p.Start();
                return new ProcessContoller(p);
            }
            catch (Exception ex)
            {
                Log.Logger.Error(ex, "Start");
            }

            return null;
        }

        internal async Task Write(char command)
        {
            //Console.WriteLine("Write:{0}", arg: command);
            await Writer.WriteAsync(command);
        }
        internal async Task WriteLine(string command)
        {
            //Console.WriteLine("WriteLine:{0}", arg: command);
            //await Writer.WriteAsync($"{command}\n\r");
            await Writer.WriteLineAsync(command);
            await Writer.FlushAsync();
        }

        public void Close()
        {
            Writer.Flush();
            Writer.Close();
            Process.WaitForExit();
            OutputData = ReadFrom(Reader);
            Console.WriteLine(OutputData);
            ErrorData = ReadFrom(ErrorReader);
            Console.WriteLine(ErrorData);
        }
        private string ReadFrom(StreamReader reader)
        {
            var x = new char[1];
            reader.Read(x, 0, 1);
            return $"{x.FirstOrDefault()}{reader.ReadToEnd()}";
        }
    }
}
