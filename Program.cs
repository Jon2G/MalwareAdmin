using AsyncAwaitBestPractices;
using Blazorise;
using Blazorise.Bootstrap;
using Blazorise.Icons.FontAwesome;
using Kit;
using LiteDB;
using MalwareAdmin.Utils;
using MalwareAdmin.ViewModels;
using Microsoft.AspNetCore.Http.Connections;
using MudBlazor.Services;
using PanoramicData.Blazor.Extensions;

Kit.Razor.Tools.Init();
var builder = WebApplication.CreateBuilder(args);
string ip = Kit.IPAddressExtensions.GetLocalIPAddress();
builder.WebHost.UseUrls($"http://{ip}:5500");
Console.WriteLine($"Running on http://{ip}:5500");
builder.WebHost.UseDefaultServiceProvider(options => options.ValidateScopes = false);
// Add services to the container.
builder.Services
    .AddBlazorise(options =>
    {
        options.Immediate = true;
    })
    .AddBootstrapProviders()
    .AddFontAwesomeIcons()
    .AddServerSideBlazor();
builder.Services.AddRazorPages().AddNewtonsoftJson();
builder.Services.AddPanoramicDataBlazor();
builder.Services.AddMudServices();
builder.Services.AddScoped<Radzen.DialogService>();
builder.Services.AddMvc().AddNewtonsoftJson();

Tools.Container.Register<LiteDatabase>(((container, overloads) =>
{
    string LiteDBPath = $"{Tools.Instance.LibraryPath}/LiteDb/MalwareAdmin";
    FileInfo file = new FileInfo(LiteDBPath);
    if (!file.Directory.Exists)
    {
        file.Directory.Create();
    }
    LiteDatabase database = new LiteDatabase(new ConnectionString()
    {
        Filename = file.FullName,
        Connection = ConnectionType.Shared,
        ReadOnly = false
    });
    Tools.Container.Register(database);
    return database;
}));
builder.Services.AddSingleton<LiteDatabase>((s) => Tools.Container.Get<LiteDatabase>());


var app = builder.Build();
if (!app.Environment.IsDevelopment())
{
    app.UseExceptionHandler("/Error");
    // The default HSTS value is 30 days. You may want to change this for production scenarios, see https://aka.ms/aspnetcore-hsts.
    app.UseHsts();
}

app.UseHttpsRedirection();

app.UseStaticFiles();

app.UseRouting();
app.UseEndpoints(endpoints =>
{
    endpoints.MapControllers(); // for download and upload endpoints
    endpoints.MapBlazorHub(options => { options.Transports = HttpTransportType.LongPolling; });
    endpoints.MapFallbackToPage("/_Host");
});
//app.MapBlazorHub();
//app.MapFallbackToPage("/_Host");
Task.Delay(2000)
.ContinueWith(async t=>{

new Thread(() => MalwareAdmin.Utils.CommandLineUtils.ExecuteAndContinueAsync(CommandLineViewModel.BinBash,
"ulimit -n 1000000",
"sudo sysctl -w fs.file-max=1000000",
"sudo ip link set vboxnet0 up",
"sudo ip addr add 192.168.56.1/24 dev vboxnet0"
).Wait()).Start();
await Task.Delay(1000);
new Thread(() => MalwareAdmin.Utils.CommandLineUtils.ExecuteAsync(CommandLineViewModel.BinBash, "echo fs.inotify.max_user_instances=524288 | sudo tee -a /etc/sysctl.conf && sudo sysctl -p").Wait()).Start();
await Task.Delay(1000);
new Thread(() => MalwareAdmin.Utils.CommandLineUtils.ExecuteAndContinueAsync(CommandLineViewModel.Cuckoos, $"cuckoo api --host {ip} --port {CuckooUtils.PORT}").Wait()).Start();
await Task.Delay(1000);
new Thread(() => MalwareAdmin.Utils.CommandLineUtils.ExecuteAndContinueAsync(CommandLineViewModel.Cuckoos, $"cuckoo web runserver {ip}:8090").Wait()).Start();
await Task.Delay(1000);
new Thread(() => MalwareAdmin.Utils.CommandLineUtils.ExecuteAndContinueAsync(CommandLineViewModel.Cuckoos, "cuckoo").Wait()).Start();
await Task.Delay(1000);
new Thread(() => MalwareAdmin.Utils.CommandLineUtils.ExecuteAndContinueAsync(CommandLineViewModel.Viper, $"viper").Wait()).Start();
await Task.Delay(1000);
new Thread(() => MalwareAdmin.Utils.CommandLineUtils.ExecuteAsync(CommandLineViewModel.BinBash, "lsb_release -a").Wait()).Start();
await Task.Delay(1000);
new Thread(() => MalwareAdmin.Utils.CommandLineUtils.ExecuteAsync(CommandLineViewModel.FakeNet, "sudo fakenet").Wait()).Start();
}).SafeFireAndForget();
app.Run();
