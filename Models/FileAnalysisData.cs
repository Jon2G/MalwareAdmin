using AsyncAwaitBestPractices;
using Kit;
using Kit.Model;
using LiteDB;
using MalwareAdmin.Models.Files;
using MalwareAdmin.Utils;
using VirusTotalNet.Results.v3;

namespace MalwareAdmin.Models
{
    public class FileAnalysisData : ModelBase, IComparable, IEquatable<FileAnalysisData>
    {
        [BsonId(false)]
        public string MD5 => VTotalReport.MD5;
        public bool IsOnViper { get; set; }

        private VirusTotalNet.Results.v3.FileReport _VTotalReport;

        public VirusTotalNet.Results.v3.FileReport VTotalReport
        {
            get => _VTotalReport;
            set
            {
                _VTotalReport = value;
                Raise(() => VTotalReport);
            }
        }
        private static readonly object CollectionLock = new object();
        public static readonly ILiteCollection<FileAnalysisData> _Collection = Kit.Tools.Container.Get<LiteDatabase>().GetCollection<FileAnalysisData>();
        public static ILiteCollection<FileAnalysisData> Collection
        {
            get
            {
                lock (CollectionLock)
                {
                    return _Collection;
                }
            }
        }
        public FileAnalysisData()
        {
            VTotalReport = new FileReport();
        }
        public static FileAnalysisData GetLocalAnalysisData(FileObject file)
        {
            FileReport vtReport = new FileReport()
            {
                MD5 = file.MD5
            };
            FileAnalysisData data = new FileAnalysisData()
            {
                VTotalReport = vtReport
            };
            if (string.IsNullOrEmpty(data.MD5))
            {
                vtReport.MD5 = file.GetMD5();
            }
            if (string.IsNullOrEmpty(vtReport.SHA1))
            {
                vtReport.SHA1 = file.GetSHA1();
            }
            if (string.IsNullOrEmpty(vtReport.SHA256))
            {
                vtReport.SHA256 = file.GetSHA256();
            }

            if (string.IsNullOrEmpty(vtReport.SSDeep))
            {
                file.GetFuzzyHash().SafeFireAndForget();
            }
            vtReport.Size = file.File.Length;
            return data;
        }
        public int CompareTo(object? obj)
        {
            if (obj is FileAnalysisData other)
            {
                return other.MD5.CompareTo(this.MD5);
            }
            return -1;
        }

        public bool Equals(FileAnalysisData? other)
        {
            return this.CompareTo(other) == 0;
        }

        public async Task<bool> Delete()
        {
            if (IsOnViper)
            {
                await ViperUtils.RemoveSample(MD5);
            }
            return Collection.Delete(MD5);
        }
        public FileAnalysisData Save()
        {
            Collection.Upsert(this);
            return this;
        }
    }
}
