using Kit.Model;
using LiteDB;
using MalwareAdmin.Data;
using MalwareAdmin.Models.Files;
using System;
using VirusTotalNet.Results.v3;

namespace MalwareAdmin.Models
{
    public class FileAnalysisData : ModelBase, IComparable, IEquatable<FileAnalysisData>
    {
        [BsonId(false)]
        public string MD5 => VTotalReport.MD5;
        public bool IsOnViper { get; set; }

        private VirusTotalNet.Results.v3.FileReport _VTotalReport;

        public VirusTotalNet.Results.v3.FileReport VTotalReport
        {
            get => _VTotalReport;
            set
            {
                _VTotalReport = value;
                Raise(() => VTotalReport);
            }
        }

        public FileAnalysisData()
        {

        }
        public static FileAnalysisData GetLocalAnalysisData(FileObject file)
        {
            FileReport vtReport = new FileReport()
            {
                MD5 = file.MD5
            };
            FileAnalysisData data = new FileAnalysisData()
            {
                VTotalReport = vtReport
            };
            if (string.IsNullOrEmpty(data.MD5))
            {
                vtReport.MD5 = file.GetMD5();
            }
            if (string.IsNullOrEmpty(vtReport.SHA1))
            {
                vtReport.SHA1 = file.GetSHA1();
            }
            if (string.IsNullOrEmpty(vtReport.SHA256))
            {
                vtReport.SHA256 = file.GetSHA256();
            }

            if (string.IsNullOrEmpty(vtReport.SSDeep))
            {
                vtReport.SSDeep = file.GetFuzzyHash();
            }
            vtReport.Size = file.File.Length;
            return data;
        }
        public int CompareTo(object? obj)
        {
            if (obj is FileAnalysisData other)
            {
                return other.MD5.CompareTo(this.MD5);
            }
            return -1;
        }

        public bool Equals(FileAnalysisData? other)
        {
            return this.CompareTo(other) == 0;
        }

        public FileAnalysisData Save()
        {
            AppData.Database.GetCollection<FileAnalysisData>().Upsert(this);
            return this;
        }
    }
}
